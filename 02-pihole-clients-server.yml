---
- name: Install and Configure Pi-hole with Unbound using Docker
  hosts: pihole_clients_server
  become: yes
  vars:
    docker_user: "michael"
    compose_dir: "/home/michael/docker"

  tasks:
    - name: Install required system packages
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add Docker repository (using Debian Bookworm)
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian bookworm stable"
        state: present
        filename: docker

    - name: Update package list
      apt:
        update_cache: yes

    - name: Install Docker and Docker Compose
      apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-compose-plugin
        state: present

    - name: Add user to Docker group
      user:
        name: "{{ docker_user }}"
        groups: docker
        append: yes

    - name: Enable and restart Docker service
      systemd:
        name: docker
        state: restarted
        enabled: yes

    - name: Create Docker Compose directory
      file:
        path: "{{ compose_dir }}"
        state: directory
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0755'

    - name: Deploy Docker Compose file for Pi-hole and Unbound
      copy:
        dest: "{{ compose_dir }}/docker-compose.yml"
        content: |
          version: '3.8'

          services:
            pihole:
              container_name: pihole
              image: pihole/pihole:latest
              ports:
                - "10.10.116.30:53:53/tcp"
                - "10.10.116.30:53:53/udp"
                - "10.11.112.30:80:80/tcp"
                - "10.11.112.30:443:443/tcp"
              environment:
                TZ: "Europe/Amsterdam"
                WEBPASSWORD: kashmir02
                DNS1: "127.0.0.1#5335"
                DNS2: "8.8.8.8"  # Backup public DNS
                VIRTUAL_HOST: "pi.hole"
                PIHOLE_DNS_: "127.0.0.1#5335"
              volumes:
                - "./pihole:/etc/pihole"
                - "./dnsmasq:/etc/dnsmasq.d"
              restart: unless-stopped
              networks:
                dns_net:
                  ipv4_address: 192.168.1.2

            unbound:
              container_name: unbound
              image: mvance/unbound:latest
              restart: unless-stopped
              networks:
                dns_net:
                  ipv4_address: 192.168.1.3
              ports:
                - "5335:5335/tcp"

          networks:
            dns_net:
              driver: bridge
              ipam:
                config:
                  - subnet: 192.168.1.0/24

        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        mode: '0644'

    - name: Ensure correct ownership for Docker directory
      file:
        path: "{{ compose_dir }}"
        owner: "{{ docker_user }}"
        group: "{{ docker_user }}"
        recurse: yes

    - name: Start Pi-hole and Unbound containers
      command: docker compose up -d
      args:
        chdir: "{{ compose_dir }}"

    - name: Display Pi-hole web interface URL
      debug:
        msg: "Pi-hole is running at http://{{ ansible_host }}/admin"
