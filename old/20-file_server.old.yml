---
- name: Configure file server
  hosts: file_server
  become: true  # Run with sudo privileges

### Set variables
  
  vars_files:
    
    - group_vars/file_server/secrets.yml
    - group_vars/file_server/common.yml

### Run all tasks

  tasks:

## Create paths and mount all filesystems

    - name: Create required directories (excluding Btrfs-managed paths)
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop:
        - /swap      # Mountpoint for swapfile
        - /srv/nvme  # Base for NVMe subvolumes
        - /srv/nfs   # Base for NFS bind mounts
        - /srv/smb   # Base for SMB bind mounts
        - /srv/mnt   # Directory for remote NFS mounts
        - /srv/nfs/backup
        - /srv/nfs/iso
        - /srv/smb/michael

    - name: Mount Btrfs subvolumes (NVMe U.2 Drive)
      ansible.builtin.mount:
        path: "{{ item.path }}"
        src: "UUID=19583b5d-8c79-4f16-b902-153124679f5e"
        fstype: btrfs
        opts: "{{ item.opts }}"
        state: mounted
      loop:
        - { path: "/swap", opts: "subvol=@swap,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/home", opts: "subvol=@home,noatime,nodev,nosuid,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/srv/nvme", opts: "subvol=@srv_nvme,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/srv/nvme/backup", opts: "subvol=@srv_nvme_backup,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/srv/nvme/michael", opts: "subvol=@srv_nvme_michael,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/srv/nvme/iso", opts: "subvol=@srv_nvme_iso,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/home/podman/data", opts: "subvol=^podman_data,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/home/podman/data/nextcloud", opts: "subvol=^podman_data_nextcloud,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }
        - { path: "/home/podman/data/sabnzbd", opts: "subvol=^podman_data_sabnzbd,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }        
        
    - name: Mount Btrfs root NVMe U.2 Drive
      ansible.builtin.mount:
        path: "{{ item.path }}"
        src: "UUID={{ item.uuid }}"
        fstype: btrfs
        opts: "{{ item.opts }}"
        state: mounted
      loop:
        - { path: "/srv/nvme/btrfsroot", uuid: "19583b5d-8c79-4f16-b902-153124679f5e", opts: "noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd" }

    - name: Bind mount directories
      ansible.builtin.mount:
        path: "{{ item.dest }}"
        src: "{{ item.src }}"
        fstype: none
        opts: "bind"
        state: mounted
      loop:
        - { src: "/srv/nvme/backup", dest: "/srv/nfs/backup" }
        - { src: "/srv/nvme/iso", dest: "/srv/nfs/iso"}
        - { src: "/srv/nvme/michael", dest: "/srv/smb/michael"}
               
    - name: Ensure all mounts are persistent in /etc/fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        line: "{{ item }}" 
        state: present
      loop:
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /swap btrfs subvol=@swap,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /home btrfs subvol=@home,noatime,nodev,nosuid,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /srv/nvme btrfs subvol=@srv_nvme,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /srv/nvme/backup btrfs subvol=@srv_nvme_backup,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /srv/nvme/michael btrfs subvol=@srv_nvme_michael,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /srv/nvme/iso btrfs subvol=@srv_nvme_iso,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /srv/nvme/btrfsroot btrfs noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /home/podman/data btrfs subvol=^podman_data,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /home/podman/data/nextcloud btrfs subvol=^podman_data_nextcloud,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "UUID=19583b5d-8c79-4f16-b902-153124679f5e /home/podman/data/sabnzbd btrfs subvol=^podman_data_sabnzbd,noatime,nodev,nosuid,noexec,compress=zstd,autodefrag,space_cache=v2,ssd 0 0"
        - "/swap/swapfile none swap defaults 0 0"
        - "/srv/nvme/backup /srv/nfs/backup none bind 0 0"
        - "/srv/nvme/iso /srv/nfs/iso none bind 0 0"
        - "/srv/nvme/michael /srv/smb/michael none bind 0 0"

## Set FQDN

    - name: Set hostname with hostnamectl
      ansible.builtin.command:
        cmd: "hostnamectl set-hostname {{ fqdn }}"
      changed_when: true

    - name: Ensure /etc/hosts contains proper FQDN mapping
      ansible.builtin.lineinfile:
        path: /etc/hosts
        regexp: "^127\\.0\\.1\\.1\\s+"
        line: "127.0.1.1 {{ fqdn }} {{ hostname }}"
        state: present
        create: yes
      
    - name: Ensure /etc/hostname contains only short hostname
      ansible.builtin.copy:
        content: "{{ hostname }}\n"
        dest: /etc/hostname
        owner: root
        group: root
        mode: '0644'

## install packages

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - samba
          - smbclient
          - python3-samba
          - cifs-utils
          - htop
          - iotop
          - strace
          - lsof
          - mc
          - auditd
          - nfs-kernel-server
          - btrfs-progs
          - firewalld
          - git
          - rsync
          - fastfetch
          - lynis
          - podman
          - podman-compose
          - slirp4netns
          - uidmap
          - python3-podman
          - auditd
          - jq
          - systemd-container            
          - unbound
          - bind9-utils
          - dnsutils
          - plocate
        state: present
        update_cache: yes

## configue firewalld

    - name: Ensure Firewalld is running and enabled
      ansible.builtin.systemd:
        name: firewalld
        enabled: yes
        state: started

    - name: Check existing Firewalld zones
      ansible.builtin.command: "firewall-cmd --get-zones"
      register: firewalld_existing_zones
      changed_when: false

    - name: Create Firewalld zones if missing
      ansible.builtin.firewalld:
        zone: "{{ item }}"
        permanent: yes
        state: present
      loop:
        - servers
        - 10G
        - containers
        - nfs
        - smb
      when: "item not in firewalld_existing_zones.stdout"

    - name: Reload Firewalld to apply new zones
      ansible.builtin.command:
        cmd: "firewall-cmd --reload"
      changed_when: false 
       
    - name: Bind interfaces to Firewalld zones
      ansible.builtin.firewalld:
        zone: "{{ item.zone }}"
        interface: "{{ item.interface }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop:
        - { zone: "servers", interface: "eth0" }
        - { zone: "10G", interface: "eth1" }
        - { zone: "containers", interface: "eth2" }
        - { zone: "nfs", interface: "eth3" }
        - { zone: "smb", interface: "eth4" }
        
    - name: Allow required services in Firewalld zones
      ansible.builtin.firewalld:
        zone: "{{ item.zone }}"
        service: "{{ item.service }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop:
        - { zone: "servers", service: "ssh" }
        - { zone: "servers", service: "samba" }
        - { zone: "servers", service: "ssh" }
        - { zone: "servers", service: "dns" }
        - { zone: "servers", service: "dhcp" }
        - { zone: "servers", service: "ntp" }
        - { zone: "10G", service: "samba" }
        - { zone: "10G", service: "http" }
        - { zone: "10G", service: "https" }
        - { zone: "10G", service: "dns" }
        - { zone: "10G", service: "dhcp" }
        - { zone: "10G", service: "ntp" }
        - { zone: "nfs", service: "nfs" }
        - { zone: "nfs", service: "mountd" }
        - { zone: "nfs", service: "rpc-bind" }
        - { zone: "smb", service: "samba" }
        
    - name: Open required ports in Firewalld zones
      ansible.builtin.firewalld:
        zone: "{{ item.zone }}"
        port: "{{ item.port }}"
        permanent: yes
        immediate: yes
        state: enabled
      loop:
        - { zone: "nfs", port: "32767/tcp" }
        - { zone: "nfs", port: "32767/udp" }
        - { zone: "nfs", port: "32765/tcp" }
        - { zone: "nfs", port: "32765/udp" }
        - { zone: "containers", port: "8053/tcp" }
        - { zone: "containers", port: "8053/udp" }
        - { zone: "containers", port: "8080/tcp" }
        - { zone: "containers", port: "8081/tcp" }
        - { zone: "containers", port: "8082/tcp" }
        - { zone: "containers", port: "8083/tcp" }
        - { zone: "containers", port: "8084/tcp" }

    - name: Enable IP forwarding
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: yes
        state: present
        reload: yes
      
    - name: Redirect common ports for rootless podman (rich rules)
      ansible.posix.firewalld:
        zone: "{{ item.zone }}"
        rich_rule: 'rule family="ipv4" forward-port port="{{ item.src_port }}" protocol="{{ item.protocol }}" to-port="{{ item.to_port }}"'
        permanent: yes
        immediate: yes
        state: enabled  
      loop:
        - { zone: "servers", src_port: 53,  protocol: "tcp", to_port: 8053 }
        - { zone: "servers", src_port: 53,  protocol: "udp", to_port: 8053 }
        - { zone: "servers", src_port: 67,  protocol: "tcp", to_port: 8067 }
        - { zone: "servers", src_port: 67,  protocol: "udp", to_port: 8067 }
        - { zone: "servers", src_port: 123, protocol: "udp", to_port: 8123 }
        - { zone: "10G",    src_port: 80,  protocol: "tcp", to_port: 8080 }        
        - { zone: "10G",    src_port: 443, protocol: "tcp", to_port: 8443 }
        - { zone: "10G",    src_port: 53,  protocol: "tcp", to_port: 8053 }
        - { zone: "10G",    src_port: 53,  protocol: "udp", to_port: 8053 }
        - { zone: "10G",    src_port: 67,  protocol: "tcp", to_port: 8067 }
        - { zone: "10G",    src_port: 67,  protocol: "udp", to_port: 8067 }
        - { zone: "10G",    src_port: 123, protocol: "udp", to_port: 8123 }
        
    - name: Reload Firewalld to apply changes
      ansible.builtin.command:
        cmd: "firewall-cmd --reload"

## Set password and keys for admin user

    - name: Set michael’s Linux password
      ansible.builtin.user:
        name: michael
        password: "{{ michael_password | password_hash('sha512') }}"

    - name: Check if SSH private key exists for user michael
      ansible.builtin.stat:
        path: /home/michael/.ssh/id_rsa
      register: michael_ssh_key

    - name: Create .ssh directory for michael (if needed)
      file:
        path: /home/michael/.ssh
        state: directory
        owner: michael
        group: michael
        mode: '0700'

    - name: Generate SSH key for michael if it doesn't exist
      become_user: michael
      community.crypto.openssh_keypair:
        path: /home/michael/.ssh/id_rsa
        type: rsa
        size: 4096
        passphrase: "{{ ssh_key_passphrase }}"
        comment: "michael@{{ inventory_hostname }}"
      when: not michael_ssh_key.stat.exists

    - name: Read public SSH key
      slurp:
        src: /home/michael/.ssh/id_rsa.pub
      register: michael_public_key
      become_user: michael

    - name: Create /home/michael/build directory with proper ownership
      file:
        path: /home/michael/build
        state: directory
        owner: michael
        group: michael
        mode: '0755'

## Create bash aliases for root

    - name: Ensure aliases are present in .bashrc for root
      ansible.builtin.lineinfile:
        path: "{{ item.bashrc }}"
        line: "{{ item.alias }}"
        create: yes
        owner: "{{ item.user }}"
        group: "{{ item.user }}"
        mode: '0644'
        insertafter: EOF
      loop:
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias gs='git status'" }
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias c='clear'" }
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias h='history'" }
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias ls='ls -alh --color=auto'" }
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias df='df -h'" }
        - { user: 'root', bashrc: '/root/.bashrc', alias: "alias ports='ss -tulpn'" }

## Deploy unbound configuration

    - name: Deploy unbound config file
      ansible.builtin.template:
          src: file_server/unbound/unbound.conf.j2
          dest: /etc/unbound/unbound.conf.d/pi-hole.conf
          owner: root
          group: root
          mode: '0644'

    - name: Stop en disable unbound-resolvconf.service
      ansible.builtin.systemd:
        name: unbound-resolvconf.service
        state: stopped
        enabled: false

## Configure fastfetch for running after login

    - name: Make fastfetch run for every interactive shell
      become: true
      ansible.builtin.copy:
        dest: /etc/profile.d/fastfetch.sh
        owner: root
        group: root
        mode: '0755'
        content: |
          #!/bin/sh
          # only run in an interactive terminal
          if [ -t 1 ] && command -v fastfetch >/dev/null 2>&1; then
            fastfetch
          fi

## Configure NFS and shares
    
    - name: Ensure NFS service is running and enabled
      ansible.builtin.systemd:
        name: nfs-server
        enabled: yes
        state: started

    - name: Define NFS exports
      ansible.builtin.blockinfile:
        path: /etc/exports
        block: |
          /srv/nfs 10.12.112.50(rw,fsid=0,all_squash,anonuid={{ nobody_uid }},anongid={{ nobody_gid }}) 10.12.112.55(rw,fsid=0,all_squash,anonuid={{ nobody_uid }},anongid={{ nobody_gid }})
          /srv/nfs/iso 10.12.112.10(rw,fsid=1,all_squash,anonuid={{ nobody_uid }},anongid={{ nobody_gid }}) 10.12.112.11(rw,fsid=1,all_squash,anonuid={{ nobody_uid }},anongid={{ nobody_gid }})
          /srv/nfs/backup 10.12.112.0/24(rw,fsid=2,all_squash,anonuid={{ nobody_uid }},anongid={{ nobody_gid }})
        marker: "# {mark} ANSIBLE MANAGED BLOCK"
     
    - name: Add Nobody-User in [Mapping]
      ansible.builtin.ini_file:
        path: /etc/idmapd.conf
        section: Mapping
        option: Nobody-User
        value: nobody
        backup: yes

    - name: Add Nobody-Group in [Mapping]
      ansible.builtin.ini_file:
        path: /etc/idmapd.conf
        section: Mapping
        option: Nobody-Group
        value: nobody
        backup: yes

    - name: Export NFS shares
      ansible.builtin.command: exportfs -ra
      changed_when: false

    - name: Set fixed ports for NFS services in /etc/nfs.conf
      ansible.builtin.blockinfile:
        path: /etc/nfs.conf
        marker: "# {mark} ANSIBLE MANAGED NFS PORTS"
        block: |
          [mountd]
          port=20048

          [lockd]
          port=32767
          udp-port=32767

          [statd]
          port=32765
          udp-port=32765

    - name: Create valid /etc/idmapd.conf
      copy:
        dest: /etc/idmapd.conf
        content: |
          [General]
          Verbosity = 0
          Domain = home.arpa

          [Mapping]
          Nobody-User = nobody
          Nobody-Group = nogroup
        mode: '0644'
      
## Configure Samba

    - name: Ensure michael is in the sambashare group
      ansible.builtin.user:
        name: michael
        groups: sambashare
        append: yes

    - name: Ensure /home/michael is owned by michael:michael (recursively)
      ansible.builtin.file:
        path: /home/michael
        owner: michael
        group: michael
        recurse: yes
        state: directory

    - name: Create Samba users for each share
      ansible.builtin.shell: |
        echo -e "{{ lookup('vars', item + '_smb_password') }}\n{{ lookup('vars', item + '_smb_password') }}" \
          | smbpasswd -s -a {{ item }}
      args:
        executable: /bin/bash
      loop:
        - michael

    - name: Ensure share directories have correct owner/group and mode
      ansible.builtin.file:
        path: "{{ item.path }}"
        owner: "{{ item.owner }}"
        group: "{{ item.group }}"
        mode: "{{ item.mode }}"
        recurse: no
      loop:
        - { path: "/srv/smb/michael",       owner: michael,  group: michael,  mode: "2770" }
        
    - name: Deploy custom smb.conf
      ansible.builtin.template:
        src: file_server/samba/smb.conf.j2
        dest: /etc/samba/smb.conf
        owner: root
        group: root
        mode: '0644'
      
## Configure podman user for running rootless containers

    - name: Ensure user 'podman' exists with a specific password
      ansible.builtin.user:
        name: podman
        shell: /bin/bash
        home: /home/podman
        
    - name: Set podman’s Linux password
      ansible.builtin.user:
        name: podman
        password: "{{ podman_password | password_hash('sha512') }}"
        
    - name: Ensure podman has authorized SSH key
      ansible.posix.authorized_key:
        user: podman
        state: present
        key: "{{ podman_ssh_pubkey }}"

    - name: Get podman user's UID
      command: id -u podman
      register: podman_uid_cmd
      changed_when: false

    - name: Set podman_uid fact
      set_fact:
        podman_uid: "{{ podman_uid_cmd.stdout }}"

    - name: Get podman user's GID
      ansible.builtin.command:
        cmd: "id -g podman"
      register: podman_gid_cmd
      changed_when: false

    - name: Set podman_gid fact
      ansible.builtin.set_fact:
        podman_gid: "{{ podman_gid_cmd.stdout }}"

    - name: Enable linger for podman user so socket survives reboot
      command: loginctl enable-linger podman

    - name: Ensure podman.socket is enabled and running for podman user
      ansible.builtin.command: >
        sudo -u podman env XDG_RUNTIME_DIR=/run/user/{{ podman_uid }}
        systemctl --user enable --now podman.socket

    - name: Ensure podman's bashrc exports DOCKER_HOST
      lineinfile:
        path: /home/podman/.bashrc
        line: 'export DOCKER_HOST=unix://$XDG_RUNTIME_DIR/podman/podman.sock'
        create: yes
        owner: podman
        group: podman
        mode: '0644'

    - name: Create systemd user unit directory
      file:
        path: /home/podman/.config/systemd/user
        state: directory
        owner: podman
        group: podman
        mode: '0755'

## Set podman registries

    - name: Deploy podman registries file
      ansible.builtin.template:
        src: file_server/podman/registries.conf.j2
        dest: /etc/registries.conf
        owner: root
        group: root
        mode: '0644'

    - name: Deploy podman user registries file
      ansible.builtin.template:
        src: file_server/podman/podman_registries.conf.j2
        dest: /home/podman/.config/containers/registries.conf
        owner: podman
        group: podman
        mode: '0644'

    # - name: Create required directories for podman 
    #   ansible.builtin.file:
    #     path: "{{ item }}"
    #     state: directory
    #     owner: podman
    #     group: podman
    #     mode: '0644'
    #   loop:
    #     - /home/podman/data/nextcloud/nextcloud_html/data

## Set file ownership for podman paths

    # - name: Create required directories for podman 
    #   ansible.builtin.file:
    #     path: "{{ item }}"
    #     state: directory
    #     owner: podman
    #     group: podman
    #     mode: '0644'
    #   loop:
    #     - /home/podman/data/nextcloud/nextcloud_db
    #     - /home/podman/data/nextcloud/redis
    #     - /home/podman/data/nextcloud/nextcloud_html
    #     - /home/podman/data/nextcloud/nextcloud_html/config
    #     - /home/podman/data/nextcloud/nextcloud_html/data
        
    # - name: Get base subuid for user 'podman'
    #   ansible.builtin.command:
    #     argv:
    #       - awk
    #       - '-F:'
    #       - '$1 == "podman" { print $2 }'
    #       - /etc/subuid
    #   register: podman_subuid
    #   changed_when: false

    # - name: Get base subgid for user 'podman'
    #   ansible.builtin.command:
    #     argv:
    #       - awk
    #       - '-F:'
    #       - '$1 == "podman" { print $2 }'
    #       - /etc/subgid
    #   register: podman_subgid
    #   changed_when: false

    # - name: Calculate mapped UID and GID for www-data (UID 33)
    #   set_fact:
    #     wwwdata_host_uid: "{{ podman_subuid.stdout | int + 33 }}"
    #     wwwdata_host_gid: "{{ podman_subgid.stdout | int + 33 }}"

    # - name: Ensure correct ownership and permissions for Nextcloud directories
    #   ansible.builtin.file:
    #     path: "{{ item }}"
    #     owner: "{{ wwwdata_host_uid }}"
    #     group: "{{ wwwdata_host_gid }}"
    #     mode: "u+rwX"
    #     recurse: yes
    #   loop:
    #     - /home/podman/data/nextcloud/nextcloud_html
    #     - /home/podman/data/nextcloud/nextcloud_html/config
    #     - /home/podman/data/nextcloud/nextcloud_html/data

    # - name: Set MariaDB mapped UID/GID
    #   set_fact:
    #     mariadb_host_uid: "{{ podman_subuid.stdout | int + 999 }}"
    #     mariadb_host_gid: "{{ podman_subgid.stdout | int + 999 }}"

    # - name: Ensure correct ownership and permissions for MariaDB volume
    #   ansible.builtin.file:
    #     path: /home/podman/data/nextcloud/nextcloud_db
    #     owner: "{{ mariadb_host_uid }}"
    #     group: "{{ mariadb_host_gid }}"
    #     mode: "u+rwX"
    #     recurse: yes

## Deploy podman containers

# NTP

    - name: Deploy NTP compose file
      ansible.builtin.template:
        src: file_server/compose/ntp/compose.yml.j2
        dest: /home/podman/compose/ntp/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start NTP
      copy:
        dest: /home/podman/.config/systemd/user/ntp.service
        content: |
          [Unit]
          Description=NTP
          
          [Service]
          WorkingDirectory=/home/podman/compose/ntp
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

# Nginx Proxy Manager

    - name: Deploy npm compose file
      ansible.builtin.template:
        src: file_server/compose/npm/compose.yml.j2
        dest: /home/podman/compose/npm/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Deploy npm env file
      ansible.builtin.template:
        src: file_server/compose/npm/.env.j2
        dest: /home/podman/compose/npm/.env
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start Nginx Proxy Manager
      copy:
        dest: /home/podman/.config/systemd/user/npm.service
        content: |
          [Unit]
          Description=Nginx Proxy Manager
          
          [Service]
          WorkingDirectory=/home/podman/compose/npm
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

# Heimdall

    - name: Deploy Heimdall compose file
      ansible.builtin.template:
        src: file_server/compose/heimdall/compose.yml.j2
        dest: /home/podman/compose/heimdall/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start Heimdall
      copy:
        dest: /home/podman/.config/systemd/user/heimdall.service
        content: |
          [Unit]
          Description=Heimdall
          
          [Service]
          WorkingDirectory=/home/podman/compose/heimdall
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

# Pihole-clients

    - name: Deploy Pihole-clients compose file
      ansible.builtin.template:
        src: file_server/compose/pihole-clients/compose.yml.j2
        dest: /home/podman/compose/pihole-clients/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Deploy Pihole-clients env file
      ansible.builtin.template:
        src: file_server/compose/pihole-clients/.env.j2
        dest: /home/podman/compose/pihole-clients/.env
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start Pihole-clients
      copy:
        dest: /home/podman/.config/systemd/user/pihole-clients.service
        content: |
          [Unit]
          Description=Pihole-clients
          
          [Service]
          WorkingDirectory=/home/podman/compose/pihole-clients
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

# Pihole-servers

    - name: Deploy Pihole-servers compose file
      ansible.builtin.template:
        src: file_server/compose/pihole-servers/compose.yml.j2
        dest: /home/podman/compose/pihole-servers/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Deploy Pihole-servers env file
      ansible.builtin.template:
        src: file_server/compose/pihole-servers/.env.j2
        dest: /home/podman/compose/pihole-servers/.env
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start Pihole-servers
      copy:
        dest: /home/podman/.config/systemd/user/pihole-servers.service
        content: |
          [Unit]
          Description=Pihole-clients
          
          [Service]
          WorkingDirectory=/home/podman/compose/pihole-servers
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

# Nextcloud

    - name: Deploy Nextcloud compose file
      ansible.builtin.template:
        src: file_server/compose/nextcloud/compose.yml.j2
        dest: /home/podman/compose/nextcloud/compose.yml
        owner: podman
        group: podman
        mode: '0644'

    - name: Deploy Nextcloud env file
      ansible.builtin.template:
        src: file_server/compose/nextcloud/.env.j2
        dest: /home/podman/compose/nextcloud/.env
        owner: podman
        group: podman
        mode: '0644'

    - name: Install systemd unit to start Nextcloud
      copy:
        dest: /home/podman/.config/systemd/user/nextcloud.service
        content: |
          [Unit]
          Description=Nextcloud
          
          [Service]
          WorkingDirectory=/home/podman/compose/nextcloud
          ExecStart=/usr/bin/podman-compose up
          ExecStop=/usr/bin/podman-compose down
          Restart=always
          TimeoutStartSec=0
          StandardOutput=journal
          StandardError=journal

          [Install]
          WantedBy=default.target
        owner: podman
        group: podman
        mode: '0644'

  - name: Deploy Nextcloud config.php file
      ansible.builtin.template:
        src: file_server/compose/nextcloud/config.php.j2
        dest: /home/podman/compose/nextcloud/config.php
        owner: podman
        group: podman
        mode: '0644'



    # - name: Install systemd unit to start Nextcloud cron service
    #   copy:
    #     dest: /home/podman/.config/systemd/user/nextcloud-cron.service
    #     content: |
    #       [Unit]
    #       Description=Nextcloud Cron

    #       [Service]
    #       ExecStart=/usr/bin/podman exec -u www-data nextcloud-app php /var/www/html/cron.php
    #     owner: podman
    #     group: podman
    #     mode: '0644'

    # - name: Install systemd unit to start Nextcloud cron timer
    #   copy:
    #     dest: /home/podman/.config/systemd/user/nextcloud-cron.timer
    #     content: |
    #       [Unit]
    #       Description=Run Nextcloud cron.php every 5 minutes

    #       [Timer]
    #       OnBootSec=2min
    #       OnUnitActiveSec=5min
    #       Persistent=true

    #       [Install]
    #       WantedBy=default.target
    #     owner: podman
    #     group: podman
    #     mode: '0644'

    # - name: Deploy Nextcloud post install script
    #   ansible.builtin.template:
    #     src: file_server/compose/nextcloud/init.sh.j2
    #     dest: /home/podman/data/nextcloud/init.sh
    #     owner: podman
    #     group: podman
    #     mode: '0644'

## Reload systemd and enable/start containers

    - name: Reload systemd user units for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user daemon-reload'

# NTP Server

    - name: Enable NTP service for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable ntp.service'

# Nginx Proxy Manager

    - name: Enable NPM service for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable npm.service'

# Heimdall

    - name: Enable Heimdall service for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable heimdall.service'

# Pihole-clients

    - name: Enable Pihole-clients service for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable pihole-clients.service'

# Pihole-servers

    - name: Enable Pihole-servers service for podman
      command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable pihole-servers.service'

# Nextcloud

    # - name: Enable Nextcloud service for podman
    #   command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable nextcloud.service'

    # - name: Enable cron timer
    #   command: machinectl shell podman@ /bin/bash -c 'systemctl --user enable nextcloud-cron.timer'
      
## Finishing deployment by rebooting the server

    - name: Reboot the server
      ansible.builtin.reboot:
        reboot_timeout: 600     # wait up to 10 minutes for reboot
        test_command: whoami    # command to verify SSH is back
      tags: reboot

    - name: Reset SSH connection after reboot
      meta: reset_connection
      tags: reboot