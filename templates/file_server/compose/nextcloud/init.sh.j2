#!/bin/bash

set -e

echo "ğŸ•’ Waiting for database (${MYSQL_HOST})..."
until mysqladmin ping -h "${MYSQL_HOST}" --silent; do
  sleep 1
done

echo "ğŸ•’ Waiting for config.php to be created..."
while [ ! -f /var/www/html/config/config.php ]; do
  sleep 2
done

echo "ğŸ”§ Fixing ownership and permissions in container user namespace..."
chown -R "$(id -u):$(id -g)" /var/www/html
chmod -R u+rwX /var/www/html

echo "ğŸ•’ Waiting a bit longer for initialization to finish..."
sleep 10

echo "âš™ï¸ Configuring Nextcloud via occ..."
php occ config:system:set trusted_domains 1 --value="${NEXTCLOUD_TRUSTED_DOMAIN}"
php occ config:system:set overwritehost --value="${NEXTCLOUD_TRUSTED_DOMAIN}"
php occ config:system:set overwriteprotocol --value="https"
php occ config:system:set trusted_proxies 0 --value="${NEXTCLOUD_TRUSTED_PROXY}"

echo "âœ… Initialization complete â€“ starting Apache"
exec apache2-foreground
