#!/bin/bash

set -e

echo "ğŸ•’ Waiting for database (${MYSQL_HOST}:3306)..."
while ! (echo > /dev/tcp/${MYSQL_HOST}/3306) >/dev/null 2>&1; do
  sleep 1
done

echo "ğŸ•’ Waiting for config.php to be created..."
while [ ! -f /var/www/html/config/config.php ]; do
  sleep 2
done

echo "ğŸ•’ Waiting a bit longer for initialization to finish..."
sleep 20

echo "âš™ï¸ Checking if Nextcloud is installed..."
if php occ status | grep -q "installed: true"; then
  echo "âœ… Nextcloud is installed â€“ configuring settings..."

  echo "ğŸ”§ Setting trusted domains..."
  php occ config:system:set trusted_domains 0 --value="${NEXTCLOUD_TRUSTED_DOMAIN}"
  php occ config:system:set trusted_domains 1 --value="10.11.112.20"

  echo "ğŸ”§ Setting overwrite settings..."
  php occ config:system:set overwritehost --value="${NEXTCLOUD_TRUSTED_DOMAIN}"
  php occ config:system:set overwriteprotocol --value="https"
  php occ config:system:set overwrite.cli.url --value="https://${NEXTCLOUD_TRUSTED_DOMAIN}"
  php occ config:system:set trusted_proxies 0 --value="${NEXTCLOUD_TRUSTED_PROXY}"

  echo "ğŸ”§ Enabling Redis cache..."
  php occ config:system:set memcache.local --value='\OC\Memcache\Redis' --type=string
  php occ config:system:set memcache.locking --value='\OC\Memcache\Redis' --type=string
  php occ config:system:set redis --value='{"host":"redis","port":6379,"timeout":1.5}' --type=json

  echo "ğŸ” Setting background job mode to cron..."
  php occ background:cron

else
  echo "â­ï¸ Skipping occ config â€“ Nextcloud not yet installed."
fi

echo "âœ… Initialization complete â€“ starting Apache"
exec apache2-foreground
