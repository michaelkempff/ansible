#!/bin/bash

set -e

echo "🕒 Waiting for database (${MYSQL_HOST}:3306)..."
while ! (echo > /dev/tcp/${MYSQL_HOST}/3306) >/dev/null 2>&1; do
  sleep 1
done

echo "🕒 Waiting for config.php to be created..."
while [ ! -f /var/www/html/config/config.php ]; do
  sleep 2
done

echo "🕒 Waiting a bit longer for initialization to finish..."
sleep 20

echo "⚙️ Checking if Nextcloud is installed..."
if php occ status | grep -q "installed: true"; then
  echo "✅ Nextcloud is installed – configuring settings..."
  php occ config:system:set trusted_domains 1 --value="nextcloud.storagemedia.online"
  php occ config:system:set overwritehost --value="nextcloud.storagemedia.online"
  php occ config:system:set overwriteprotocol --value="https"
  php occ config:system:set trusted_proxies 0 --value="10.10.116.20"
else
  echo "⏭️ Skipping occ config – Nextcloud not yet installed."
fi

echo "✅ Initialization complete – starting Apache"
exec apache2-foreground
